自己結合（Self-Join）は、SQLで同じテーブルを複数回使用して、テーブル内の異なる行を比較するために行う結合です。自己結合は、通常、1つのテーブルの異なる行の間に何らかの関係がある場合に使用されます。

### 自己結合の概要

自己結合は、通常の結合と同じように動作しますが、同じテーブルを2回、異なるエイリアス（別名）で参照します。これにより、同じテーブル内の2つの行を結びつけて操作できます。

### 自己結合の例

例えば、従業員テーブル（`Employees`）があり、各従業員の上司（マネージャー）が同じテーブルで管理されているとします。このテーブルは以下のような構造を持っていると仮定します。

```plaintext
+----+---------+------------+
| ID | Name    | Manager_ID |
+----+---------+------------+
| 1  | Alice   | NULL       |
| 2  | Bob     | 1          |
| 3  | Carol   | 1          |
| 4  | David   | 2          |
+----+---------+------------+
```

このテーブルでは、`Manager_ID`がその従業員の上司の`ID`を参照しています。自己結合を使って、各従業員の名前とその上司の名前を取得することができます。

### 自己結合のSQLクエリ

```sql
SELECT E1.Name AS Employee, E2.Name AS Manager
FROM Employees E1
LEFT JOIN Employees E2 ON E1.Manager_ID = E2.ID;
```

このクエリでは、`Employees`テーブルを2回使用し、`E1`と`E2`というエイリアスを付けています。

- `E1`は従業員そのものを表します。
- `E2`は上司を表すために同じテーブルを参照しています。

クエリの結果は以下のようになります:

```plaintext
+----------+---------+
| Employee | Manager |
+----------+---------+
| Alice    | NULL    |
| Bob      | Alice   |
| Carol    | Alice   |
| David    | Bob     |
+----------+---------+
```

### 自己結合の用途

自己結合はさまざまな状況で有効です。例えば：

1. **階層的データの操作:** 組織構造、フォルダ構造、ツリー状のデータなど、階層的なデータを操作する際に使用されます。
2. **自身との比較:** テーブル内の行同士を比較する場合（例：価格変動、異なる日付のデータの比較など）。

### 注意点
- **パフォーマンス:** 自己結合は、特に大規模なテーブルで使用する場合、クエリのパフォーマンスに影響を与えることがあります。適切なインデックスを設定することが重要です。
- **エイリアスの使用:** 自己結合では、同じテーブルを複数回参照するため、必ずエイリアスを使用してテーブルを区別する必要があります。

自己結合を効果的に使用することで、単一のテーブルから複雑なデータ関係を抽出することができます。
