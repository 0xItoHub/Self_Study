`WHERE` 句と `HAVING` 句は、どちらもSQLにおける条件フィルタリングに使用されますが、使用するタイミングや目的に違いがあります。

### `WHERE` 句
- **目的**: レコードをフィルタリングするために使用します。`WHERE` 句は、**集計関数を使用する前** に各行に対して条件を適用します。
- **使用タイミング**: 行レベルのフィルタリング。集計が行われる前に、テーブル内のデータを制限します。

#### 例: `WHERE` 句の使用
```sql
SELECT employee_id, salary
FROM employees
WHERE salary > 5000;
```
このクエリは、`salary` 列の値が5000を超える行をフィルタリングし、その従業員のIDと給与を返します。

- **動作**: データベースは `employees` テーブルから `salary` が5000を超える行だけを選択します。このフィルタリングは、集計操作やグループ化が行われる前に適用されます。

### `HAVING` 句
- **目的**: `HAVING` 句は、**集計関数を使用した結果** に対して条件を適用します。`GROUP BY` でグループ化した後の各グループに対してフィルタリングを行います。
- **使用タイミング**: グループ化された後、または集計結果に基づいてフィルタリングを行う場合に使用します。

#### 例: `HAVING` 句の使用
```sql
SELECT department_id, AVG(salary)
FROM employees
GROUP BY department_id
HAVING AVG(salary) > 5000;
```
このクエリは、各部署ごとに平均給与が5000を超える部署だけを選択し、部署IDと平均給与を返します。

- **動作**: データベースはまず `department_id` ごとにグループ化し、各グループの平均給与を計算します。その後、`HAVING` 句によって平均給与が5000を超えるグループだけがフィルタリングされます。

### `WHERE` と `HAVING` の違い

1. **フィルタリングの適用タイミング**:
   - `WHERE`: **集計やグループ化の前に** 各行に対してフィルタリングを行います。個々の行を対象とするため、集計関数は使用できません。
   - `HAVING`: **集計やグループ化の後に** 各グループに対してフィルタリングを行います。集計関数を使用してフィルタリングする場合はこちらが使われます。

2. **使用可能な条件**:
   - `WHERE`: 行に対する条件。例えば、特定の値を持つ行を選択する際に使用されます。
   - `HAVING`: グループ化されたデータに対する条件。集計関数（例: `SUM`, `COUNT`, `AVG` など）に基づいてフィルタリングする際に使用されます。

### 例: `WHERE` と `HAVING` の併用

```sql
SELECT department_id, COUNT(*) AS employee_count
FROM employees
WHERE salary > 5000
GROUP BY department_id
HAVING COUNT(*) > 5;
```

- **`WHERE` 句**: このクエリは、まず `salary` が5000を超える従業員をフィルタリングします。
- **`GROUP BY`**: その後、`department_id` ごとに従業員をグループ化します。
- **`HAVING` 句**: グループ化された後、従業員数が5人を超える部署だけがフィルタリングされます。

### まとめ

- **`WHERE` 句**: 個々の行に対してフィルタリングを行う（集計やグループ化の前に）。
- **`HAVING` 句**: グループ化や集計の後に、集計結果に基づいてフィルタリングを行う。

`WHERE` 句は行ベースの条件指定、`HAVING` 句はグループベースの条件指定と覚えると使い分けがしやすくなります。
