SQLトランザクションは、データベースでの一連の操作を**1つの論理的単位**として実行し、データの整合性を保つための重要な仕組みです。トランザクションは、複数のSQLステートメント（例えば、`INSERT`、`UPDATE`、`DELETE`）をまとめて実行し、その結果が正しく完了するか、あるいはすべての変更が取り消されるかを決定します。

### トランザクションの4つの特性（ACID特性）
トランザクションには、次の4つの重要な特性があります。これらは、トランザクションの信頼性を確保するための基本原則です。

1. **Atomicity（原子性）**:
   - トランザクション内のすべての操作は、**全て実行されるか、全く実行されないか**のどちらかです。つまり、トランザクションが成功すれば、全ての変更が適用されますが、失敗すれば全ての変更が取り消されます。

2. **Consistency（一貫性）**:
   - トランザクションの実行前後で、データベースの**整合性**が保たれることが保証されます。これにより、データベースが常に有効な状態を維持します。

3. **Isolation（分離性）**:
   - トランザクションは他のトランザクションから**独立して実行**されます。1つのトランザクションが完了するまで、その結果は他のトランザクションに見えないようにすることができます。

4. **Durability（耐久性）**:
   - トランザクションが一度コミット（確定）されると、その変更は永続的にデータベースに保存され、システム障害が発生しても失われることはありません。

### トランザクションの基本操作

SQLトランザクションは、次のコマンドを使用して制御されます。

1. **`BEGIN`** または **`START TRANSACTION`**:
   - トランザクションの開始を宣言します。このコマンド以降、データベースに対して行われる操作は、明示的にコミットされるまで1つのトランザクションとして扱われます。

2. **`COMMIT`**:
   - トランザクション内のすべての変更をデータベースに適用し、トランザクションを確定します。`COMMIT`が実行されると、トランザクションで行ったすべての操作がデータベースに永続化されます。

3. **`ROLLBACK`**:
   - トランザクション内で行われたすべての操作を取り消し、データベースをトランザクション開始前の状態に戻します。エラーが発生したり、何らかの理由で変更を反映したくない場合に使用します。

4. **`SAVEPOINT`**:
   - トランザクション内での途中経過を保存するポイントを設定できます。`SAVEPOINT`を使用することで、指定されたポイントまでロールバックすることができます。

5. **`RELEASE SAVEPOINT`**:
   - 指定されたセーブポイントを削除します。

### トランザクションの実例

以下はトランザクションの基本的な例です。

```sql
START TRANSACTION;

INSERT INTO accounts (account_number, balance) VALUES (123456, 1000);
UPDATE accounts SET balance = balance - 100 WHERE account_number = 123456;
UPDATE accounts SET balance = balance + 100 WHERE account_number = 654321;

COMMIT;
```

この例では、複数の操作が1つのトランザクション内で実行されています。最後に`COMMIT`を実行することで、全ての操作がデータベースに確定されます。もし途中でエラーが発生した場合、`ROLLBACK`を使用してすべての操作を元に戻すことができます。

### トランザクションの分離レベル

トランザクションの**分離性**を制御するために、SQLでは**分離レベル**を設定することができます。分離レベルとは、トランザクションが他のトランザクションからどれだけ隔離されるかを定義するものです。これにより、データの一貫性やパフォーマンスのトレードオフが調整されます。

1. **READ UNCOMMITTED**:
   - 他のトランザクションで未確定の変更が見えることを許可します。データの一貫性は低くなりますが、パフォーマンスは向上します。

2. **READ COMMITTED**:
   - 他のトランザクションで確定した変更だけを読み取ることを許可します。未確定のデータは見えません。

3. **REPEATABLE READ**:
   - トランザクション内で同じクエリを複数回実行した際に、同じ結果が返されることを保証します。他のトランザクションがデータを変更することができないため、安定した読み取りが行えます。

4. **SERIALIZABLE**:
   - 最も厳格な分離レベルで、トランザクションが完全に独立して実行されるように制御されます。これにより、データの整合性が保証されますが、パフォーマンスが低下する可能性があります。

### まとめ

トランザクションはデータベースにおける複数の操作を1つの単位として実行し、データの整合性や信頼性を保つために重要です。トランザクションを使うことで、アプリケーションが安全にデータ操作を行うことができ、特に銀行の振込処理や在庫管理など、クリティカルな操作においては欠かせない仕組みです。
